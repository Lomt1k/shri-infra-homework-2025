name: ğŸš€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°

on:
  workflow_dispatch: {}

jobs:
  release:
    name: ğŸ“¦ Ğ ĞµĞ»Ğ¸Ğ· v${{ github.run_number }}
    runs-on: ubuntu-latest
    environment: production

    env:
      REGISTRY_URL: cr.yandex
      APP_NAME: app
      YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
      DOCKER_IMAGE_LATEST: ${{ format('{0}/{1}/{2}:{3}_latest', env.REGISTRY_URL, env.YC_REGISTRY_ID, env.APP_NAME, github.run_number) }}
      DOCKER_IMAGE_VERSIONED: ${{ format('{0}/{1}/{2}:{3}', env.REGISTRY_URL, env.YC_REGISTRY_ID, env.APP_NAME, github.run_number) }}

    steps:
      - name: ğŸ” Checkout ĞºĞ¾Ğ´Ğ°
        uses: actions/checkout@v4

      - name: ğŸ§  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
        run: npm ci

      - name: ğŸ§¹ ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° - Ğ›Ğ¸Ğ½Ñ‚ĞµÑ€
        run: npm run lint

      - name: ğŸ§ª ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° - Ğ¢ĞµÑÑ‚Ñ‹
        run: npm run test

      - name: ğŸŒ² Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ‚ĞºĞ¸
        run: |
          git config --global user.email "github-actions@example.com"
          git config --global user.name "GitHub Actions"
          git checkout -b releases/${{ github.run_number }}
          git push origin releases/${{ github.run_number }}

      - name: ğŸ³ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
        run: |
          docker build -t $DOCKER_IMAGE_VERSIONED .
          docker tag $DOCKER_IMAGE_VERSIONED $DOCKER_IMAGE_LATEST

      - name: ğŸ” ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Yandex Container Registry
        run: |
          echo "${{ secrets.YC_OAUTH_TOKEN }}" | docker login --username oauth --password-stdin $REGISTRY_URL

      - name: ğŸ“¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ² Container Registry
        run: |
          docker push $DOCKER_IMAGE_VERSIONED
          docker push $DOCKER_IMAGE_LATEST

      - name: ğŸ· Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞ³Ğ° Ğ²ĞµÑ€ÑĞ¸Ğ¸
        run: |
          git tag v${{ github.run_number }}
          git push origin v${{ github.run_number }}

      - name: ğŸ“œ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ² Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
        id: commits
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ || echo 'initial')
          COMMITS=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
          echo "commits=$COMMITS" >> $GITHUB_ENV

      - name: ğŸ“ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ CHANGELOG.md
        run: |
          NEW_ENTRY="## v${{ github.run_number }}\n$(date '+%Y-%m-%d')\n$COMMITS\n"
          sed -i "1i\\$NEW_ENTRY\n" CHANGELOG.md || echo -e "$NEW_ENTRY\n" > CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "docs: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ CHANGELOG Ğ´Ğ»Ñ v${{ github.run_number }}"
          git push origin main

      - name: ğŸ§¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Issue Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğµ
        uses: actions/github-script@v6
        with:
          script: |
            const body = `
              ğŸ“… Ğ”Ğ°Ñ‚Ğ°: ${new Date().toISOString()}
              ğŸ‘¨â€ğŸ’» ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
              ğŸ“¦ Ğ’ĞµÑ€ÑĞ¸Ñ: v${{ github.run_number }}
              ğŸ“¦ Docker image: $DOCKER_IMAGE_VERSIONED
              ğŸ“Œ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñ‹ Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°:
              ${{ env.COMMITS }}
            `;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš€ Ğ’Ñ‹Ğ¿ÑƒÑĞº Ñ€ĞµĞ»Ğ¸Ğ·Ğ° v${{ github.run_number }}`,
              body: body
            });
