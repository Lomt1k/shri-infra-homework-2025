name: ğŸš€ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°

on:
  workflow_dispatch: {}

jobs:
  release:
    name: ğŸ“¦ Ğ ĞµĞ»Ğ¸Ğ· v${{ github.run_number }}
    runs-on: ubuntu-latest
    environment: production

    env:
      REGISTRY_URL: cr.yandex
      APP_NAME: app
      YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}

    steps:
      - name: ğŸ” Checkout ĞºĞ¾Ğ´Ğ°
        uses: actions/checkout@v4

      - name: ğŸ§  ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
        run: npm ci

      - name: ğŸ§¹ ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° - Ğ»Ğ¸Ğ½Ñ‚ĞµÑ€
        run: npm run lint

      - name: ğŸ§ª ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° - Ñ‚ĞµÑÑ‚Ñ‹
        run: npm run test

      - name: ğŸŒ² Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ»Ğ¸Ğ·Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ‚ĞºĞ¸
        run: |
          git config --global user.email "github-actions@example.com"
          git config --global user.name "GitHub Actions"
          git checkout -b releases/${{ github.run_number }}
          git push origin releases/${{ github.run_number }}

      - name: ğŸ³ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
        run: |
          DOCKER_IMAGE_LATEST=${REGISTRY_URL}/${YC_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}_latest
          DOCKER_IMAGE_VERSIONED=${REGISTRY_URL}/${YC_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}
          docker build -t $DOCKER_IMAGE_VERSIONED .
          docker tag $DOCKER_IMAGE_VERSIONED $DOCKER_IMAGE_LATEST

      - name: ğŸ” ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Yandex Container Registry
        run: |
          echo "${{ secrets.YC_OAUTH_TOKEN }}" | docker login --username oauth --password-stdin $REGISTRY_URL

      - name: ğŸ“¤ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ² Container Registry
        run: |
          DOCKER_IMAGE_LATEST=${REGISTRY_URL}/${YC_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}_latest
          DOCKER_IMAGE_VERSIONED=${REGISTRY_URL}/${YC_REGISTRY_ID}/${APP_NAME}:${{ github.run_number }}
          docker push $DOCKER_IMAGE_VERSIONED
          docker push $DOCKER_IMAGE_LATEST

      - name: ğŸ· Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‚ĞµĞ³Ğ° Ğ²ĞµÑ€ÑĞ¸Ğ¸
        run: |
          git tag v${{ github.run_number }}
          git push origin v${{ github.run_number }}

      - name: ğŸ“œ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ² Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°
        id: commits
        run: |
          # ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ‚ĞµĞ³
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo 'initial')
          
          # Ğ•ÑĞ»Ğ¸ LAST_TAG â€” ÑÑ‚Ğ¾ 'initial', Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚, Ñ‚ĞµĞ³Ğ¾Ğ² Ğ½ĞµÑ‚, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ HEAD~1
          if [ "$LAST_TAG" = "initial" ]; then
            COMMITS=$(git log --pretty=format:"- %s" HEAD~1..HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s" $LAST_TAG..HEAD)
          fi
          
          # Ğ•ÑĞ»Ğ¸ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ² Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
          if [ -z "$COMMITS" ]; then
            COMMITS="ĞĞµÑ‚ Ğ½Ğ¾Ğ²Ñ‹Ñ… ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ²"
          fi
          
          echo "commits=$COMMITS" >> $GITHUB_ENV

      - name: ğŸ“ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ CHANGELOG.md
        run: |
          NEW_ENTRY="## v${{ github.run_number }}\n$(date '+%Y-%m-%d')\n$COMMITS\n"
          if [ -f CHANGELOG.md ]; then
            sed -i "1i\\$NEW_ENTRY\n" CHANGELOG.md
          else
            echo -e "$NEW_ENTRY\n" > CHANGELOG.md
          fi
          git add CHANGELOG.md
          git commit -m "docs: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ CHANGELOG Ğ´Ğ»Ñ v${{ github.run_number }}"
          git push origin main

      - name: ğŸ§¾ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Issue Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğµ
        uses: actions/github-script@v6
        with:
          script: |
            const body = `
              ğŸ“… Ğ”Ğ°Ñ‚Ğ°: ${new Date().toISOString()}
              ğŸ‘¨â€ğŸ’» ĞĞ²Ñ‚Ğ¾Ñ€: ${{ github.actor }}
              ğŸ“¦ Ğ’ĞµÑ€ÑĞ¸Ñ: v${{ github.run_number }}
              ğŸ“¦ Docker image: ${{ env.REGISTRY_URL }}/${{ env.YC_REGISTRY_ID }}/${{ env.APP_NAME }}:${{ github.run_number }}
              ğŸ“Œ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ñ‹ Ñ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğ³Ğ¾ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°:
              ${{ env.COMMITS }}
            `;
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ğŸš€ Ğ’Ñ‹Ğ¿ÑƒÑĞº Ñ€ĞµĞ»Ğ¸Ğ·Ğ° v${{ github.run_number }}",
              body: body
            });